---
title: "EDA_amy"
author: "Amy Pitts"
date: '2022-04-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(tidyverse)
library(gtsummary)
library(mice)
library(lme4)

```

## Load Data

```{r}
df = read_excel("Proj 4 data.xlsx") %>%
  janitor::clean_names() %>%
  mutate(
    group = factor(group),
    time_int = case_when(
      time == 1 ~ "baseline",
      time == 2 ~ "6-month",
      time == 3 ~ "12-month"
    ),
    time_int = factor(time_int, levels = c("baseline", "6-month","12-month")),
    school = factor(school)
  ) %>%
  separate(id, c("id", "one"), sep="_") %>%
  select(-one) %>%
  mutate(id = as.numeric(id))
df %>% head()

```

Data Summary
```{r}
df %>% select(-c(id, time)) %>%
  tbl_summary(by=group) %>%
  add_overall() 


df %>% select(-c(id, time)) %>%
  filter(time_int == "baseline") %>%
  tbl_summary(by=group) %>%
  add_overall() 


# at baseline 
df %>% select(-id) %>%
  filter(time == 1) %>%
  select(group, sfd) %>%
  tbl_summary(by=group) %>%
  add_overall() %>%
  add_p()
```


Spaghetti plot 

```{r}
df %>%
  mutate(
    group = ifelse(group == 0 , "Control", "Intervention")
  ) %>% 
  ggplot(aes(y=sfd, x=time_int, group=id, color = group))+
  geom_point() +
  geom_line() +
  facet_wrap(~school) +
  labs(
    title = "Symptom free Asthma days by School ",
    y = "Symptom free days in the past two weeks"
  )

```

```{r}
df %>%
  mutate(
    group = ifelse(group == 0 , "Control", "Intervention")
  ) %>% 
  ggplot(aes(x=sfd, fill = group))+
  geom_histogram(position = "identity", alpha = 0.7) +
  facet_grid(group~time_int) +
  labs(
    title = "Symptom free Asthma days by School ",
    y = "Count"
  )

```

Want to use sfd_reverse so we are looking at days where there are symptoms. 




Why is there is someone that had zero days? 

```{r}
df %>% 
  filter(sfd == 0) %>%
  select(id) %>%
  group_by(id) %>% 
  count() %>%
  arrange(desc(n))
```

So there is one person who didn't have any symptoms in the time span. So that is kinda weird... 

There are 5 people with only 2 zero days. 
```{r}
df %>% 
  filter(id %in% c("2009", "3011", "3022", "4014", "4024")) %>%
  filter(sfd != 0)
```

Not all on the middle obs but some are.... 


Missing data 

```{r}
data_spread_day = df %>% 
  pivot_wider(
    names_from = time_int, 
    id_cols = id,
    #names_prefix = "day",
    values_from = sfd
)

data_spread_day %>%
 select(-c(id)) %>%
  md.pattern(rotate.names = TRUE)
```

So the 3 people that have missing obs for all `sfd` are just going to be excluded. 

As long as the people have baseline obs then we can used them. So 14 people with have observations extrapolated. 

We want to compare Group Intervention vs Group Control. 

Let the observations be denoted 

$$Y_{ij} = 1, \dots, n \ \ (\textrm{main unit}); \ \  j=1, \dots, m_i \ \ (\textrm{subunit})$$
Note that $m_1 \not= m_2$ so that that main units do not contain the same number of subunits. 

A random effect model is useful to induce to induce the correlation among the subunits as follows: 

$$Y_{ij} = \mu_i + e_{ij}$$

$ \mu_i$ and $e_{ij}$ are independent. 

The between-cluster variability is: $E[\mu_i] = \mu_y$, $Var(\mu_i) = \sigma_b^2$

The within-cluster, between-subunit variability is: $E[e_{ij}] = 0$, $Var(e_{ij}) = \sigma^2_w $

Thus the total variance of an observation $Y_{ij}$ and the covariance between observations is $Y_{ij}$ and $Y_{ik}$ within the $i$th cluster are 

$$Var(Y_{ij}) = \sigma^2 = \sigma^2_b + \sigma^2_w$$

$$Cov(Y_{ij}, Y_{ik}) = Var (\mu_i) = \sigma_b^2$$
Thus the correlation among subunits within a cluster equals $\rho = \frac{\sigma^2_b}{\sigma^2}$. This correlation is the same across all subunits and is called the compoind symmetry model in the repeated measures context. 



### Binomial Model 

The Model in question: 

$Y_i \sim Bin(14, p_i)$. \textbf{Need to check assumption of indepencence!}

Let $i$ be subject, $j \in (1,2,3,4)$ be school, and $k \in (1,2,3)$ by the measurement 

\[ 
\log \left(\frac{p_{ijk}}{1-p_{ijk}} \right) = \beta_0 + \beta_1 School_{ij} + \beta_2 Treat_{i} 
+ \beta_3 time_{ijk} + \beta_4 Treat_i \times time_{ijk} + \alpha_{0i} + \alpha_{0j} + \epsilon_{ijk}
\]

Where $\alpha_{0i}$ and $\alpha_{0j}$ are random intercept for subject and school. 


- one model with continuous time 

- one model with categorical time 


[This is a interesting resrouce on negative binomial](https://www.nature.com/articles/s41598-020-73883-7)

## Time as Continous

```{r}

m.p <- glmer(sfd ~ school + group + time + time * group + (1|id) + (1|school), 
              data = df, 
              family = poisson)
summary(m.p)


m.nb <- glmer.nb(sfd ~ school + group + time + time * group + (1|id) + (1|school), 
              data = df, 
              verbose=TRUE)

summary(m.nb)
## The neg.binomial theta parameter:
#getME(m.nb, "glmer.nb.theta")

var_names = c("intercept", "school2", "school3", "school4", "time", "group1:time")
mod.nb <- summary(m.nb)
mod.p <- summary(m.p)

est_nb_df = mod.nb$coefficients %>% as_tibble() %>%
  janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_nb = estimate,
         p_nb = pr_z) %>%
  select(var_names, est_nb, p_nb)
est_nb_p = mod.p$coefficients %>% as_tibble() %>%
   janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_p = estimate,
         p_p = pr_z) %>%
  select(var_names, est_p, p_p)

full_join(est_nb_df, est_nb_p, by="var_names") %>% 
  mutate_at(2:5, round, 3)
```

```{r}
m.p <- glmer(sfd ~  group + time + time * group + (1|id) + (1|school), 
              data = df, 
              family = poisson)
summary(m.p)


m.nb <- glmer.nb(sfd ~ group + time + time * group + (1|id) + (1|school), 
              data = df, 
              verbose=TRUE)

summary(m.nb)
## The neg.binomial theta parameter:
#getME(m.nb, "glmer.nb.theta")

var_names = c("intercept", "group1", "time", "group1:time")
mod.nb <- summary(m.nb)
mod.p <- summary(m.p)

est_nb_df = mod.nb$coefficients %>% as_tibble() %>%
  janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_nb = estimate,
         p_nb = pr_z) %>%
  select(var_names, est_nb, p_nb)
est_nb_p = mod.p$coefficients %>% as_tibble() %>%
   janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_p = estimate,
         p_p = pr_z) %>%
  select(var_names, est_p, p_p)

full_join(est_nb_df, est_nb_p, by="var_names") %>% 
  mutate_at(2:5, round, 3)
```


# Time as Categorical

```{r}
df1 = df %>% mutate(time = factor(time))
m.p <- glmer(sfd ~  school + time + time * group + (1|id) + (1|school), 
              data = df1, 
              family = poisson)
summary(m.p)


m.nb <- glmer.nb(sfd ~ school + time + time * group + (1|id) + (1|school), 
              data = df1, 
              verbose=TRUE)

summary(m.nb)
## The neg.binomial theta parameter:
#getME(m.nb, "glmer.nb.theta")

var_names = c("intercept", "school2","school3","school4", "time2", "time3", "group1:time2","group1:time3")
mod.nb <- summary(m.nb)
mod.p <- summary(m.p)

est_nb_df = mod.nb$coefficients %>% as_tibble() %>%
  janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_nb = estimate,
         p_nb = pr_z) %>%
  select(var_names, est_nb, p_nb)
est_nb_p = mod.p$coefficients %>% as_tibble() %>%
   janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_p = estimate,
         p_p = pr_z) %>%
  select(var_names, est_p, p_p)

full_join(est_nb_df, est_nb_p, by="var_names") %>% 
  mutate_at(2:5, round, 3)
```


```{r}
df1 = df %>% mutate(time = factor(time))
m.p <- glmer(sfd ~  group + time + time * group + (1|id) + (1|school), 
              data = df1, 
              family = poisson)
summary(m.p)


m.nb <- glmer.nb(sfd ~ group + time + time * group + (1|id) + (1|school), 
              data = df1, 
              verbose=TRUE)

summary(m.nb)
## The neg.binomial theta parameter:
#getME(m.nb, "glmer.nb.theta")

var_names = c("intercept", "group1", "time2", "time3", "group1:time2","group1:time3")
mod.nb <- summary(m.nb)
mod.p <- summary(m.p)

est_nb_df = mod.nb$coefficients %>% as_tibble() %>%
  janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_nb = estimate,
         p_nb = pr_z) %>%
  select(var_names, est_nb, p_nb)
est_nb_p = mod.p$coefficients %>% as_tibble() %>%
   janitor::clean_names() %>% 
  mutate(var_names = var_names) %>%
  relocate(var_names) %>%
  rename(est_p = estimate,
         p_p = pr_z) %>%
  select(var_names, est_p, p_p)

full_join(est_nb_df, est_nb_p, by="var_names") %>% 
  mutate_at(2:5, round, 3)
```





### Sample Size Power Stuff 

[PASS all](https://www.ncss.com/software/pass/pass-documentation/)

[Resource:](https://www.ncss.com/wp-content/themes/ncss/pdf/Procedures/PASS/Mixed_Models_Tests_for_Two_Means_in_a_2-Level_Hierarchical_Design-Level-2_Randomization.pdf)



