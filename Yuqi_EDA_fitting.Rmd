---
title: "Yuqi_EDA"
author: "Yuqi Miao ym2771"
date: "4/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(lmerTest)
library(reshape2)
library(nlme)
data = readxl::read_xlsx("Proj 4 data.xlsx") %>% 
  janitor::clean_names() %>% 
  mutate(group = factor(group, levels = c(0,1), labels = c("SOC", "Intervention")),
         school = factor(school))
```


# Data exploration 

## barplot at each time point

verify poisson might be less reasonable
```{r}
data %>% 
  ggplot(aes(x = sfd))+
  geom_bar()+
  facet_grid(time~group)
```

* heavy tail, not appropriate for poisson count

## barplot for 6 v.s. baseline and 12 v.s. baseline 

* 2 goal:
  * see distribution to verify normal trend -- middle high, 2 tail low
  * see if the control/trt group have roughly equan variance to decide 2 sample t test with equal/unequal var (continous) 

```{r}
data_change = data %>% 
  pivot_wider(id_cols = c(id, school,group),
              names_from = time,
              values_from = sfd,
              names_prefix = "time"
              ) %>% 
  mutate(m6_m0 = time2-time1,
         m12_m0 = time3-time1) %>% 
  pivot_longer(c(m6_m0, m12_m0),
               names_to = "compare",
               values_to = "sfd_change") %>% 
  mutate(compare = factor(compare, levels = c("m6_m0", "m12_m0")))

sum_dc = data_change %>% 
  group_by(compare, group) %>% 
  summarize(mean = mean(sfd_change, na.rm = T),
            median = median(sfd_change, na.rm = T))

data_change %>% 
  # filter(compare == "m6_m0") %>% 
  ggplot(aes(x = sfd_change, fill = group))+
  # geom_histogram()+
  geom_density(alpha = 0.5)+
  geom_vline(data = sum_dc, aes(xintercept = mean,color = group))+
  facet_grid(compare~.)

```

* Truely a normal like distribution, but with right tail
* different vairance: larger variance in the intervention group!

## sphagetti plot 

Goal: Disprove the linear trend and conduct the analysis using time as categorical/ independent measures

```{r}
sp_dc = data_change %>% 
  ggplot(aes(x = compare, y = sfd_change, color = group, group = id))+
  geom_line()+
  geom_point()+
  facet_grid(.~school)

sp_sfd = data %>% 
  ggplot(aes(x = time, y = sfd,color = group, group = id))+
  geom_line()+
  geom_point()+
  facet_grid(.~school)
```

* by sp_sfd, no clear linear trend along time, not appropriate to treat time as continuous variable


* Box/point plot for intra-class correlation visualization, facet by month. (https://dcricollab.dcri.duke.edu/sites/NIHKR/KR/Intraclass_Correlation_Coefficient_Cheat_Sheet_March_15_2020.pdf)

```{r}
data_change %>% 
  ggplot(aes(x = school, y = sfd_change, color = group))+
  geom_boxplot()+
  facet_grid(.~compare)
```

* Both btw/within group correlation


# Pilot study analysis


```{r}
g = lmer(sfd_change~group*compare +(1|school)+(1|id), 
           data = data_change)
# g = lmer(sfd_change~group*compare +(1|school)+(1|id), 
#            data = data_change %>% 
#            mutate(compare = factor(compare, levels = c("m12_m0","m6_m0"))))

summary(g)
# texreg::texreg(g)
confint(g)
```

```{r}
summary(g)$coefficients
```

* Conclusion: 
  * When comparing the 6 months and baseline, The increase of sfd in intervention group is 1.67(-0.69, 4.00) more than the increase of sfd in the treatment group
  * When comparing the 12 months and baseline, The increase of sfd in intervention group is 1.40(-0.76 3.63) more than the increase of sfd in the treatment group
  * No significant improvement from intervention group;
  
## estimation of ICC

```{r}
vc = as_tibble(VarCorr(g))
rho = vc$sdcor[[2]]/(vc$sdcor[[2]]+vc$sdcor[[1]])
```


# GLMM fitting


$$
\begin{aligned}
\log\frac{\pi_{ijk}}{1-\pi_{ijk}}&=\beta_0\\
&+\beta_1t_{ijk}\\
&+\beta_2I(\text{trt}=1)_i\\\
&+\gamma_{0j}\\
&+\epsilon_{ijk}
\end{aligned}
$$



Model 1 continuous t, 
Model 2 discrete t

```{r}
# random intercept model
data_fit = data %>% 
  mutate(time_categ = factor(time, levels = 1:3,
                             labels = c("base","6m", "12m")))
fit1 <- glmer(cbind(sfd, 14-sfd)~ group*time +(1|school) +(1|id), 
                  family = 'binomial', data = data_fit)
summary(fit1) 

fit2 <- glmer(cbind(sfd, 14-sfd)~ group*time_categ + (1|school) +(1|id), 
                  family = 'binomial', data = data_fit)
summary(fit2) 
```


```{r}
fit3 <- glmer(sfd ~ school + group*time +(1|id),  # not converge +(1|school)
                  family = 'poisson', data = data_fit)
summary(fit3) 

fit4 <- glmer(sfd ~ school + group*time_categ +(1|id), # not converge +(1|school)
                  family = 'poisson',data = data_fit)
summary(fit4) 
```


# Study design

If using continuous outcome: statistics: $\bar X \sim N(\mu_i, \sigma^2)$

* Hypothesis: $H_0: \mu_i-\mu_c \leq\frac{\sigma^2}{3}$, $H_1: \mu_i-\mu_c>\frac{\sigma^2}{3}$
  * Assuming equal variance?
* calculate N based on normal distribution, with multiple adjustment: $\alpha* = \alpha/4 = 0.05/4 = 0.0125$ for the 4 comparison;
* $\beta = 0.2$
* $2N = \frac{4(Z_\alpha*+Z_{\beta})}{(1/3)^2} = \frac{4*(2.241403+0.8416212)}{(1/3)^2}$
* calculate ICC: $\rho=\frac{S_b^2}{S_b^2+S_w^2}$

```{r}
N = (4*(-qnorm(0.0125)-qnorm(0.2))^2/(1/3)^2)/2
m = (1-rho)/(30/N-rho)
N_star = N*(1+(m-1)*rho)
```

* In each treat arm, we need `r N_star` samples, indicating `r m` samples per school










